# 用户管理功能手册

## 📖 功能概述

用户管理是管理员后台的核心功能之一，提供完整的用户数据查看、筛选、状态管理和活跃度追踪功能。

---

## 🎯 核心功能

### 1. 用户列表展示
- 显示所有注册用户
- 展示用户基本信息（昵称、头像、OpenID）
- 显示用户等级（VIP/普通）
- 显示订单统计（订单数、总消费）
- 显示活跃度状态（彩色指示器）
- 显示最后活跃时间

### 2. 用户筛选
- **全部用户**：显示所有用户
- **VIP用户**：消费满500元的用户
- **普通用户**：未达到VIP标准的用户
- **已封禁**：被管理员封禁的用户

### 3. 用户状态管理
- **正常用户**（active）：可以正常使用小程序
- **封禁用户**（blocked）：无法使用小程序

### 4. 活跃度追踪
- 🟢 **今日活跃** / **1-3天前**：绿色
- 🟡 **4-7天前**：黄色
- 🟠 **8-30天前**：橙色
- 🔴 **30天以上**：红色

---

## 🔧 使用指南

### 进入用户管理

```
管理员后台 → 底部导航栏 → 用户管理
```

### 筛选用户

1. 点击顶部的筛选按钮
2. 选择筛选条件（全部/VIP/普通/已封禁）
3. 列表自动更新

### 修改用户状态

1. 找到需要修改的用户
2. 点击用户卡片右侧的 "操作" 按钮
3. 选择 "解除封禁" 或 "封禁用户"
4. 确认操作

**操作提示：**
- 封禁用户时会弹出确认："确定要封禁该用户吗？封禁后用户将无法使用小程序。"
- 解封用户时会弹出确认："确定要解除封禁吗？用户将恢复正常使用权限。"

---

## 📊 数据说明

### 用户等级判定

| 等级 | 条件 |
|------|------|
| VIP用户 | 累计消费 ≥ 500元 |
| 普通用户 | 累计消费 < 500元 |

**注意：** 用户等级是根据订单数据自动计算的，不能手动修改。

### 用户状态说明

| 状态 | 显示文本 | 含义 |
|------|----------|------|
| active | VIP用户 / 普通用户 | 正常使用，根据消费自动显示等级 |
| blocked | 已封禁 | 无法使用小程序 |

### 活跃度计算规则

活跃度基于用户的 `lastActiveTime` 字段计算：

| 最后活跃时间 | 显示文本 | 颜色 |
|-------------|----------|------|
| 今天 | 今日活跃 | 🟢 绿色 |
| 1-3天前 | X天前 | 🟢 绿色 |
| 4-7天前 | X天前 | 🟡 黄色 |
| 8-30天前 | X天前 | 🟠 橙色 |
| 30天以上 | X天前 | 🔴 红色 |

---

## ⚠️ 注意事项

### 1. 权限要求
- 只有管理员可以访问用户管理页面
- 非管理员会被自动跳转回首页

### 2. 封禁功能
- 封禁用户后，该用户将无法使用小程序的任何功能
- 解封后用户立即恢复所有权限
- 建议谨慎使用封禁功能

### 3. 数据更新
- 订单统计数据实时从数据库获取
- 用户等级自动根据消费金额计算
- 活跃度基于最后活跃时间实时计算

### 4. 历史数据兼容
- 如果用户数据中status为 `inactive`，会自动显示为"普通用户"
- 保持向后兼容，不影响已有数据

---

## 🔐 数据结构

### 用户表（users）字段

```javascript
{
  _id: "xxx",                    // 记录ID
  openid: "oH2UH...",           // 微信OpenID
  nickname: "用户昵称",          // 用户昵称
  avatar: "cloud://...",        // 头像URL（云存储）
  phone: "13800138000",         // 手机号
  status: "active",             // 状态：active/blocked
  isAdmin: false,               // 是否管理员
  createdAt: "2025-01-01",      // 注册时间
  lastActiveTime: "2025-01-15"  // 最后活跃时间
}
```

### 展示数据字段

```javascript
{
  ...userBasicInfo,             // 用户基本信息
  orderCount: 10,               // 订单数量
  totalAmount: 888.88,          // 累计消费
  statusText: "VIP用户",        // 显示文本
  activityText: "今日活跃",     // 活跃度文本
  activityIndicator: "🟢",     // 活跃度指示器
  activityClass: "active-today", // CSS类名
  activityDays: 0               // 距今天数
}
```

---

## 🚀 功能优化建议

### 已实现
- ✅ 用户状态修改
- ✅ 活跃度追踪
- ✅ 彩色指示器
- ✅ 用户筛选
- ✅ 订单统计

### 未来可扩展
- ⏳ 批量操作（批量封禁/解封）
- ⏳ 用户搜索（按昵称/手机号）
- ⏳ 数据导出（Excel/CSV）
- ⏳ 用户详情页
- ⏳ 操作日志记录
- ⏳ 用户标签功能
- ⏳ 营销活动推送

---

## 🐛 常见问题

### Q1：为什么有的用户没有头像？
**A：** 可能的原因：
1. 用户还未上传头像
2. 旧数据使用了临时路径（wxfile://），已失效
3. 解决方法：用户重新上传头像

### Q2：用户等级不对？
**A：** 用户等级是根据订单数据实时计算的：
- 检查该用户的订单记录
- 确认订单状态是否为"已支付"
- 系统会自动更新统计数据

### Q3：封禁后用户还能登录吗？
**A：** 可以登录，但无法使用任何功能：
- 用户可以打开小程序
- 但会在操作时看到权限提示
- 建议在云函数中添加状态检查

### Q4：活跃度不更新？
**A：** 活跃度基于 `lastActiveTime` 字段：
- 需要在用户登录时更新该字段
- 建议在 `app.js` 的静默登录中更新
- 或在关键操作时更新

### Q5：筛选后看不到用户？
**A：** 检查筛选条件：
- "VIP用户"：只显示消费≥500元的用户
- "普通用户"：显示消费<500元的正常用户
- "已封禁"：只显示status为blocked的用户

---

## 📝 技术实现

### 文件位置
- **前端页面**：`pages/admin-users/`
  - `admin-users.js` - 逻辑
  - `admin-users.wxml` - 界面
  - `admin-users.wxss` - 样式
  - `admin-users.json` - 配置

- **云函数**：`cloud/functions/admin/index.js`
  - `getUsers` - 获取用户列表
  - `getUserOrderStats` - 获取用户订单统计
  - `updateUserStatus` - 更新用户状态

### 核心方法

```javascript
// 加载用户数据
loadUsers()

// 筛选用户
filterUsers()

// 格式化显示数据
formatUserForDisplay(user)

// 计算活跃度
calculateActivity(daysDiff)

// 修改状态
onChangeStatus(e)
```

---

## ✨ 最佳实践

1. **定期检查活跃度**
   - 关注30天未活跃用户
   - 考虑推送召回活动

2. **谨慎使用封禁功能**
   - 封禁前确认原因
   - 记录封禁理由
   - 定期复查封禁用户

3. **关注VIP用户**
   - 提供专属服务
   - 优先处理订单
   - 给予额外优惠

4. **维护用户体验**
   - 及时响应问题用户
   - 合理使用管理功能
   - 保护用户隐私

---

**文档版本：** 1.0  
**最后更新：** 2025-10-19  
**适用版本：** 绘本租赁小程序 v1.0+

