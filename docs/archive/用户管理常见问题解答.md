# ç”¨æˆ·ç®¡ç†å¸¸è§é—®é¢˜è§£ç­”

## ğŸ“… åˆ›å»ºæ—¥æœŸ
2025-10-19

---

## â“ é—®é¢˜1ï¼šç”¨æˆ·ç®¡ç†é‡Œä¸ºä»€ä¹ˆå¤šäº†ä¸€ä¸ªç”¨æˆ·ï¼Ÿ

### ğŸ’¡ **åŸå› åˆ†æ**

æ¯ä¸ªæ‰“å¼€å°ç¨‹åºçš„å¾®ä¿¡è´¦å·éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç”¨æˆ·è®°å½•ã€‚æ–°ç”¨æˆ·å‡ºç°çš„å¯èƒ½åŸå› ï¼š

#### 1. **ä¸åŒè®¾å¤‡/ç¯å¢ƒç™»å½•**
- ğŸ“± çœŸæœºè°ƒè¯•
- ğŸ’» å¾®ä¿¡å¼€å‘è€…å·¥å…·
- ğŸ”„ ä¸åŒçš„æ¨¡æ‹Ÿå™¨

> **å…³é”®ç‚¹ï¼š** å¼€å‘è€…å·¥å…·å’ŒçœŸæœºä½¿ç”¨çš„ `openid` æ˜¯**ä¸åŒçš„**ï¼Œå› æ­¤ä¼šåˆ›å»ºä¸¤ä¸ªç”¨æˆ·è®°å½•ã€‚

#### 2. **ä¸åŒå¾®ä¿¡è´¦å·**
- ğŸ‘¤ å¼€å‘è€…è´¦å·
- ğŸ‘¥ æµ‹è¯•è´¦å·
- ğŸ§ª ä½“éªŒç‰ˆåˆ†äº«ç»™å…¶ä»–äºº

#### 3. **è‡ªåŠ¨ç™»å½•æœºåˆ¶**
æŸ¥çœ‹ `app.js` ä¸­çš„ `silentLogin()` æ–¹æ³•ï¼š

```javascript
// æ–°ç”¨æˆ·ç™»å½•
const cloudRes = await wx.cloud.callFunction({
  name: 'auth',
  data: { action: 'login' }
});
```

è¿™ä¼šè°ƒç”¨ `cloud/functions/auth/index.js` çš„ `login` æ–¹æ³•ï¼š

```javascript
// å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º
if (userResult.data.length === 0) {
  const createResult = await db.collection('users').add({
    data: {
      openid: openid,
      nickname: '',
      avatar: '',
      phone: '',
      createTime: new Date(),
      updateTime: new Date(),
      status: 'active'
    }
  });
}
```

### ğŸ” **å¦‚ä½•æŸ¥çœ‹ç”¨æˆ·æ¥æº**

æ£€æŸ¥ç”¨æˆ·çš„ `openid` å’Œåˆ›å»ºæ—¶é—´ï¼š

```javascript
// åœ¨ç®¡ç†ç«¯ç”¨æˆ·åˆ—è¡¨ä¸­æŸ¥çœ‹
ç”¨æˆ·1: openid: "oH2UH7oJqp6uJiUVwDGBf6wmBG0I"  // çœŸæœº
ç”¨æˆ·2: openid: "o1234-DEVELOPER-TOOL-ID"      // å¼€å‘è€…å·¥å…·
```

### âœ… **è§£å†³æ–¹æ¡ˆ**

#### æ–¹æ¡ˆ1ï¼šæ¸…ç†æµ‹è¯•ç”¨æˆ·
åœ¨ç®¡ç†ç«¯ç”¨æˆ·ç®¡ç†ä¸­ï¼Œå°†ä¸éœ€è¦çš„ç”¨æˆ·è®¾ç½®ä¸ºã€Œå·²å°ç¦ã€çŠ¶æ€ã€‚

#### æ–¹æ¡ˆ2ï¼šåˆå¹¶ç”¨æˆ·ï¼ˆå¼€å‘å»ºè®®ï¼‰
å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨æ•°æ®åº“ä¸­æ‰‹åŠ¨åˆ é™¤æµ‹è¯•ç”¨æˆ·ï¼š
1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. ç‚¹å‡»ã€Œäº‘å¼€å‘ã€â†’ã€Œæ•°æ®åº“ã€
3. é€‰æ‹© `users` é›†åˆ
4. æ‰¾åˆ°æµ‹è¯•ç”¨æˆ·ï¼Œç‚¹å‡»åˆ é™¤

#### æ–¹æ¡ˆ3ï¼šæ·»åŠ ç”¨æˆ·æ¥æºæ ‡è¯†
åœ¨åˆ›å»ºç”¨æˆ·æ—¶æ·»åŠ æ¥æºå­—æ®µï¼š
```javascript
{
  openid: openid,
  nickname: '',
  source: 'devtools' // æˆ– 'mobile'
}
```

---

## â“ é—®é¢˜2ï¼šç”¨æˆ·çŠ¶æ€ä¸­çš„"éæ´»è·ƒç”¨æˆ·"æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼Ÿ

### ğŸ“Š **ç”¨æˆ·çŠ¶æ€å®šä¹‰è§„åˆ™**

ä»£ç ä½ç½®ï¼š`pages/admin-users/admin-users.js` â†’ `formatUserForDisplay()` æ–¹æ³•

### ğŸ¯ **çŠ¶æ€åˆ¤æ–­é€»è¾‘**

```javascript
// 1. é»˜è®¤çŠ¶æ€
let status = 'active';
let statusText = 'æ™®é€šç”¨æˆ·';

// 2. æ ¹æ®æ¶ˆè´¹æƒ…å†µåˆ¤æ–­æ˜¯å¦ä¸ºVIP
if (orderCount >= 10 || totalAmount >= 1000) {
  statusText = 'VIPç”¨æˆ·';
}

// 3. æ£€æŸ¥æ•°æ®åº“ä¸­çš„ status å­—æ®µï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
if (user.status === 'blocked') {
  status = 'blocked';
  statusText = 'å·²å°ç¦';
} else if (user.status === 'inactive') {
  status = 'inactive';
  statusText = 'éæ´»è·ƒç”¨æˆ·';
}
```

### ğŸ“‹ **å®Œæ•´çš„çŠ¶æ€è¡¨**

| æ•°æ®åº“ status | è®¢å•æ•°é‡ | æ¶ˆè´¹é‡‘é¢ | æ˜¾ç¤ºçŠ¶æ€ | è¯´æ˜ |
|--------------|---------|---------|---------|------|
| `active` | < 10 | < Â¥1000 | **æ™®é€šç”¨æˆ·** | æ­£å¸¸ç”¨æˆ·ï¼Œæ¶ˆè´¹è¾ƒå°‘ |
| `active` | â‰¥ 10 | æˆ– â‰¥ Â¥1000 | **VIPç”¨æˆ·** | é«˜ä»·å€¼ç”¨æˆ· |
| `inactive` | ä»»æ„ | ä»»æ„ | **éæ´»è·ƒç”¨æˆ·** | ç®¡ç†å‘˜æ‰‹åŠ¨è®¾ç½® |
| `blocked` | ä»»æ„ | ä»»æ„ | **å·²å°ç¦** | è¿è§„ç”¨æˆ· |

### ğŸ”‘ **å…³é”®ç‚¹è¯´æ˜**

#### 1. **"éæ´»è·ƒç”¨æˆ·"æ˜¯ç®¡ç†å‘˜æ‰‹åŠ¨è®¾ç½®çš„**
- âŒ **ä¸æ˜¯**ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­çš„
- âœ… **æ˜¯**ç®¡ç†å‘˜åœ¨ç”¨æˆ·ç®¡ç†ä¸­æ‰‹åŠ¨ä¿®æ”¹çŠ¶æ€å¾—åˆ°çš„

#### 2. **å¦‚ä½•è®¾ç½®"éæ´»è·ƒç”¨æˆ·"**
æ­¥éª¤ï¼š
1. æ‰“å¼€ç®¡ç†ç«¯
2. è¿›å…¥ã€Œç”¨æˆ·ç®¡ç†ã€
3. ç‚¹å‡»ç”¨æˆ·å³ä¾§ã€Œ...ã€æŒ‰é’®
4. é€‰æ‹©ã€Œä¿®æ”¹çŠ¶æ€ã€
5. é€‰æ‹©ã€Œæ™®é€šç”¨æˆ·ã€ï¼ˆå¯¹åº” `inactive` çŠ¶æ€ï¼‰

#### 3. **çŠ¶æ€ä¼˜å…ˆçº§**
```
æ•°æ®åº“ status å­—æ®µ > è®¢å•/æ¶ˆè´¹ç»Ÿè®¡
```

å³ä½¿ç”¨æˆ·æœ‰10ç¬”è®¢å•ï¼Œä½†å¦‚æœç®¡ç†å‘˜å°†å…¶è®¾ç½®ä¸º `inactive`ï¼Œä¾ç„¶æ˜¾ç¤ºä¸º"éæ´»è·ƒç”¨æˆ·"ã€‚

### ğŸ’¡ **ä¼˜åŒ–å»ºè®®**

ç›®å‰çš„çŠ¶æ€å‘½åå¯èƒ½æœ‰äº›æ··æ·†ï¼Œå»ºè®®ä¼˜åŒ–ï¼š

#### å½“å‰é€»è¾‘
```javascript
'active'   â†’ æ™®é€šç”¨æˆ· æˆ– VIPç”¨æˆ·ï¼ˆæ ¹æ®æ¶ˆè´¹åˆ¤æ–­ï¼‰
'inactive' â†’ éæ´»è·ƒç”¨æˆ·
'blocked'  â†’ å·²å°ç¦
```

#### å»ºè®®æ”¹è¿›
```javascript
// ä¿®æ”¹ formatUserForDisplay å‡½æ•°
if (user.status === 'blocked') {
  statusText = 'å·²å°ç¦';
} else if (user.status === 'inactive') {
  statusText = 'å·²é™åˆ¶';  // æ›´æ¸…æ™°çš„å‘½å
} else {
  // æ ¹æ®æ¶ˆè´¹æƒ…å†µåˆ¤æ–­
  if (orderCount >= 10 || totalAmount >= 1000) {
    statusText = 'VIPç”¨æˆ·';
  } else {
    statusText = 'æ™®é€šç”¨æˆ·';
  }
}
```

æˆ–è€…æ·»åŠ æ›´è¯¦ç»†çš„çŠ¶æ€ï¼š

```javascript
// æ•°æ®åº“å­—æ®µ
status: 'active' | 'inactive' | 'blocked'
vipLevel: 'normal' | 'vip' | 'svip'

// æ˜¾ç¤ºé€»è¾‘
if (status === 'blocked') {
  statusText = 'å·²å°ç¦';
} else if (status === 'inactive') {
  statusText = 'å·²é™åˆ¶';
} else {
  // æ ¹æ® vipLevel æˆ–æ¶ˆè´¹åˆ¤æ–­
  if (orderCount >= 20 || totalAmount >= 5000) {
    statusText = 'è¶…çº§VIP';
  } else if (orderCount >= 10 || totalAmount >= 1000) {
    statusText = 'VIPç”¨æˆ·';
  } else {
    statusText = 'æ™®é€šç”¨æˆ·';
  }
}
```

---

## ğŸ“ **æ€»ç»“**

### é—®é¢˜1ï¼šå¤šå‡ºçš„ç”¨æˆ·
- âœ… **æ­£å¸¸ç°è±¡**ï¼šæ¯ä¸ªä¸åŒçš„ openid éƒ½ä¼šåˆ›å»ºç”¨æˆ·
- ğŸ”§ **å¯ä»¥ç®¡ç†**ï¼šé€šè¿‡ä¿®æ”¹çŠ¶æ€æˆ–åˆ é™¤æ•°æ®åº“è®°å½•

### é—®é¢˜2ï¼šéæ´»è·ƒç”¨æˆ·å®šä¹‰
- âœ… **æ‰‹åŠ¨è®¾ç½®**ï¼šç”±ç®¡ç†å‘˜åœ¨ç”¨æˆ·ç®¡ç†ä¸­è®¾ç½®
- âœ… **ä¼˜å…ˆçº§é«˜**ï¼šæ•°æ®åº“ status å­—æ®µä¼˜å…ˆäºè®¢å•ç»Ÿè®¡
- ğŸ’¡ **å»ºè®®ä¼˜åŒ–**ï¼šæ”¹è¿›å‘½åï¼Œé¿å…æ··æ·†

---

## ğŸ› ï¸ **ç›¸å…³æ–‡ä»¶**

- `app.js` - ç”¨æˆ·è‡ªåŠ¨ç™»å½•
- `cloud/functions/auth/index.js` - ç”¨æˆ·åˆ›å»ºé€»è¾‘
- `pages/admin-users/admin-users.js` - ç”¨æˆ·çŠ¶æ€æ˜¾ç¤ºé€»è¾‘
- `cloud/functions/admin/index.js` - ç”¨æˆ·çŠ¶æ€æ›´æ–°æ¥å£

---

## ğŸ’­ **è¿›ä¸€æ­¥å»ºè®®**

å¦‚æœæ‚¨å¸Œæœ›ç³»ç»Ÿ**è‡ªåŠ¨åˆ¤æ–­éæ´»è·ƒç”¨æˆ·**ï¼Œå¯ä»¥æ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼š

```javascript
// åˆ¤æ–­ç”¨æˆ·æœ€åç™»å½•æ—¶é—´
const lastLoginTime = new Date(user.updateTime);
const now = new Date();
const daysSinceLogin = (now - lastLoginTime) / (1000 * 60 * 60 * 24);

// è¶…è¿‡30å¤©æœªç™»å½•
if (daysSinceLogin > 30) {
  statusText = 'éæ´»è·ƒç”¨æˆ·ï¼ˆ30å¤©æœªç™»å½•ï¼‰';
}

// æˆ–æ ¹æ®è®¢å•æ—¶é—´
const hasRecentOrder = orderCount > 0 && lastOrderTime > 30å¤©å‰;
if (!hasRecentOrder) {
  statusText = 'éæ´»è·ƒç”¨æˆ·ï¼ˆæ— è¿‘æœŸè®¢å•ï¼‰';
}
```

æ˜¯å¦éœ€è¦æˆ‘å¸®æ‚¨å®ç°è‡ªåŠ¨åˆ¤æ–­éæ´»è·ƒç”¨æˆ·çš„åŠŸèƒ½ï¼Ÿ

