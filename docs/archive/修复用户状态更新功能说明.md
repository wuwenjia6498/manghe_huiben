# ä¿®å¤ç”¨æˆ·çŠ¶æ€æ›´æ–°åŠŸèƒ½è¯´æ˜

## ğŸ“… ä¿®å¤æ—¥æœŸ
2025-10-19

## ğŸ› é—®é¢˜æè¿°
ç®¡ç†ç«¯ç”¨æˆ·ç®¡ç†é¡µé¢æ— æ³•ä¿®æ”¹ç”¨æˆ·çŠ¶æ€ï¼ˆactive/inactive/blockedï¼‰ã€‚

---

## ğŸ” é—®é¢˜åŸå› 

### 1. **äº‘å‡½æ•°ç¼ºå°‘æ¥å£**
`cloud/functions/admin/index.js` ä¸­ç¼ºå°‘ `updateUserStatus` æ¥å£ï¼Œæ— æ³•å¤„ç†ç”¨æˆ·çŠ¶æ€æ›´æ–°è¯·æ±‚ã€‚

### 2. **å‰ç«¯ä»…æ¨¡æ‹Ÿæ›´æ–°**
`pages/admin-users/admin-users.js` ä¸­çš„ `onChangeStatus` æ–¹æ³•åªæ˜¯æ¨¡æ‹Ÿæ›´æ–°æœ¬åœ°æ•°æ®ï¼Œæ²¡æœ‰çœŸæ­£è°ƒç”¨äº‘å‡½æ•°ã€‚

---

## âœ… ä¿®å¤å†…å®¹

### 1. **äº‘å‡½æ•° - æ·»åŠ æ›´æ–°ç”¨æˆ·çŠ¶æ€æ¥å£**
**æ–‡ä»¶ï¼š** `cloud/functions/admin/index.js`

**æ·»åŠ çš„ä»£ç ï¼š**
```javascript
// åœ¨ switch ä¸­æ·»åŠ  case
case 'updateUserStatus':
  return await updateUserStatus(event);

// æ·»åŠ å‡½æ•°å®ç°
async function updateUserStatus(event) {
  const { userId, status } = event;
  
  try {
    if (!userId) {
      throw new Error('ç”¨æˆ·IDä¸èƒ½ä¸ºç©º');
    }
    
    if (!['active', 'inactive', 'blocked'].includes(status)) {
      throw new Error('æ— æ•ˆçš„ç”¨æˆ·çŠ¶æ€');
    }
    
    const result = await db.collection('users').doc(userId).update({
      data: {
        status: status,
        updateTime: new Date()
      }
    });
    
    return {
      success: true,
      data: result,
      message: 'ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ'
    };
  } catch (error) {
    console.error('æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
    throw new Error(`æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥: ${error.message}`);
  }
}
```

### 2. **å‰ç«¯ - è°ƒç”¨äº‘å‡½æ•°æ›´æ–°ç”¨æˆ·çŠ¶æ€**
**æ–‡ä»¶ï¼š** `pages/admin-users/admin-users.js`

**ä¿®æ”¹çš„å‡½æ•°ï¼š** `onChangeStatus`

**ä¸»è¦æ”¹åŠ¨ï¼š**
- âŒ ç§»é™¤æ¨¡æ‹Ÿæ›´æ–°é€»è¾‘
- âœ… æ·»åŠ äº‘å‡½æ•°è°ƒç”¨
- âœ… æ·»åŠ åŠ è½½æç¤º
- âœ… æ·»åŠ é”™è¯¯å¤„ç†
- âœ… åŒæ—¶æ›´æ–° `users` å’Œ `allUsers` æ•°æ®

**ä¿®æ”¹åçš„ä»£ç ï¼š**
```javascript
async onChangeStatus(e) {
  const newStatus = e.currentTarget.dataset.status;
  const { currentUser } = this.data;
  
  if (!currentUser) return;

  wx.showLoading({ title: 'æ›´æ–°ä¸­...' });

  try {
    // è°ƒç”¨äº‘å‡½æ•°æ›´æ–°ç”¨æˆ·çŠ¶æ€
    const res = await wx.cloud.callFunction({
      name: 'admin',
      data: {
        action: 'updateUserStatus',
        userId: currentUser.id,  // è¿™é‡Œçš„ id å°±æ˜¯æ•°æ®åº“çš„ _id
        status: newStatus
      }
    });

    wx.hideLoading();

    if (res.result && res.result.success) {
      // æ›´æ–°æœ¬åœ°æ•°æ®å¹¶åˆ·æ–°æ˜¾ç¤º
      // ... æ›´æ–° users å’Œ allUsers
      wx.showToast({
        title: 'çŠ¶æ€ä¿®æ”¹æˆåŠŸ',
        icon: 'success'
      });
    }
  } catch (error) {
    wx.hideLoading();
    wx.showToast({
      title: error.message || 'æ›´æ–°å¤±è´¥',
      icon: 'none'
    });
  }
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### âš ï¸ é‡è¦ï¼šå¿…é¡»é‡æ–°éƒ¨ç½²äº‘å‡½æ•°ï¼

1. **æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·**

2. **å±•å¼€å·¦ä¾§ `cloudfunctions` æ–‡ä»¶å¤¹**

3. **å³é”®ç‚¹å‡» `admin` äº‘å‡½æ•°**

4. **é€‰æ‹©ã€Œä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ã€**

5. **ç­‰å¾…éƒ¨ç½²å®Œæˆ**ï¼ˆæ§åˆ¶å°ä¼šæ˜¾ç¤ºä¸Šä¼ è¿›åº¦ï¼‰

6. **é‡æ–°ç¼–è¯‘å°ç¨‹åº**ï¼ˆå¿«æ·é”®ï¼šCtrl + B æˆ– Cmd + Bï¼‰

---

## âœ… æµ‹è¯•æ­¥éª¤

éƒ¨ç½²å®Œæˆåï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æµ‹è¯•ï¼š

1. âœ… æ‰“å¼€ç®¡ç†ç«¯
2. âœ… è¿›å…¥ã€Œç”¨æˆ·ç®¡ç†ã€é¡µé¢
3. âœ… é€‰æ‹©ä¸€ä¸ªç”¨æˆ·
4. âœ… ç‚¹å‡»ç”¨æˆ·å³ä¾§çš„ã€Œ...ã€æŒ‰é’®
5. âœ… é€‰æ‹©ã€Œä¿®æ”¹çŠ¶æ€ã€
6. âœ… é€‰æ‹©æ–°çš„çŠ¶æ€ï¼ˆæ™®é€šç”¨æˆ·/VIPç”¨æˆ·/å·²å°ç¦ï¼‰
7. âœ… ç¡®è®¤æ˜¯å¦æ˜¾ç¤ºã€ŒçŠ¶æ€ä¿®æ”¹æˆåŠŸã€
8. âœ… åˆ·æ–°é¡µé¢ï¼Œç¡®è®¤çŠ¶æ€æ˜¯å¦ä¿å­˜

---

## ğŸ“‹ æ”¯æŒçš„ç”¨æˆ·çŠ¶æ€

| çŠ¶æ€å€¼ | æ˜¾ç¤ºæ–‡æœ¬ | è¯´æ˜ |
|--------|---------|------|
| `active` | VIPç”¨æˆ· | æ­£å¸¸æ´»è·ƒç”¨æˆ· |
| `inactive` | æ™®é€šç”¨æˆ· | éæ´»è·ƒç”¨æˆ· |
| `blocked` | å·²å°ç¦ | è¢«å°ç¦çš„ç”¨æˆ· |

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµç¨‹
```
å‰ç«¯ç‚¹å‡» â†’ onChangeStatus 
  â†“
è°ƒç”¨äº‘å‡½æ•° admin.updateUserStatus
  â†“
æ›´æ–°æ•°æ®åº“ users é›†åˆ
  â†“
è¿”å›æˆåŠŸç»“æœ
  â†“
æ›´æ–°å‰ç«¯æœ¬åœ°æ•°æ®
  â†“
æ˜¾ç¤ºæˆåŠŸæç¤º
```

### å…³é”®å­—æ®µè¯´æ˜
- **å‰ç«¯æ•°æ®ï¼š** `user.id` = æ•°æ®åº“ `_id`
- **äº‘å‡½æ•°å‚æ•°ï¼š** `userId` = æ•°æ®åº“ `_id`
- **æ•°æ®åº“å­—æ®µï¼š** `status`, `updateTime`

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- âœ… `cloud/functions/admin/index.js` - äº‘å‡½æ•°æ¥å£
- âœ… `pages/admin-users/admin-users.js` - å‰ç«¯é€»è¾‘
- âœ… `pages/admin-users/admin-users.wxml` - å‰ç«¯è§†å›¾
- ğŸ“– `ä»£ç ç®€åŒ–è¯´æ˜.md` - ä»£ç ç®€åŒ–æ–‡æ¡£

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¿®å¤ï¼š
1. âœ… æ·»åŠ äº†äº‘å‡½æ•° `updateUserStatus` æ¥å£
2. âœ… ä¿®å¤äº†å‰ç«¯ `onChangeStatus` æ–¹æ³•
3. âœ… å®ç°äº†çœŸæ­£çš„æ•°æ®åº“æ›´æ–°
4. âœ… æ·»åŠ äº†å®Œæ•´çš„é”™è¯¯å¤„ç†

**ç°åœ¨ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸ä¿®æ”¹ç”¨æˆ·çŠ¶æ€äº†ï¼** ğŸ‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»é‡æ–°éƒ¨ç½²äº‘å‡½æ•°**ï¼Œå¦åˆ™åŠŸèƒ½æ— æ³•ä½¿ç”¨
2. ä¿®æ”¹çŠ¶æ€éœ€è¦ç®¡ç†å‘˜æƒé™
3. çŠ¶æ€ä¿®æ”¹ä¼šç«‹å³ä¿å­˜åˆ°æ•°æ®åº“
4. åŒæ—¶æ›´æ–° `status` å’Œ `updateTime` å­—æ®µ

