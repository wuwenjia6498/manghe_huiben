# 云函数部署说明

## 部署方法

### 方法1：通过微信开发者工具部署（推荐）

#### 单个云函数部署

1. 打开微信开发者工具
2. 在左侧目录树中找到 `cloud/functions/admin` 文件夹
3. **右键点击** `admin` 文件夹
4. 选择 **"上传并部署：云端安装依赖（不上传 node_modules）"**
5. 等待部署完成（会显示上传进度和结果）

#### 批量部署所有云函数

1. 打开微信开发者工具
2. 点击工具栏的 **"云开发"** 按钮
3. 进入云开发控制台
4. 选择 **"云函数"** 标签
5. 点击 **"上传全部"** 按钮

### 方法2：通过命令行部署

如果安装了 `@cloudbase/cli`，可以使用命令行：

```bash
# 安装 cloudbase cli（仅第一次需要）
npm install -g @cloudbase/cli

# 登录
tcb login

# 部署单个云函数
tcb fn deploy admin

# 部署所有云函数
tcb fn deploy
```

## 验证部署

### 1. 查看部署日志

在微信开发者工具的 **"云开发控制台" → "云函数" → "admin"** 中查看部署时间和版本。

### 2. 查看云函数日志

1. 打开 **"云开发控制台"**
2. 选择 **"云函数"**
3. 点击 **"admin"**
4. 查看 **"日志"** 标签
5. 触发一次请求（刷新管理端首页）
6. 查看最新日志中的统计结果

### 3. 测试接口

在小程序中刷新管理端首页，观察：
- 待发货订单数量是否正确（不包含待支付订单）
- 控制台日志是否显示正确的 `pendingShipmentCount`

## 当前修改

### admin 云函数（已修改）

**文件：** `cloud/functions/admin/index.js`

**修改内容：**

```javascript
// 修改前 ❌
const pendingShipmentCount = await db.collection('orders').where({
  status: db.command.in(['pending', 'paid'])  // 包含了 pending
}).count();

// 修改后 ✅
const pendingShipmentCount = await db.collection('orders').where({
  status: 'paid'  // 只包括 paid 状态
}).count();
```

**影响：** 管理端首页的"待发货订单"数量统计

## 部署后检查

### 1. 创建测试订单

- 创建 1 个待支付订单（pending）
- 创建 1 个待发货订单（paid）

### 2. 查看数据看板

**预期结果：**
- "待发货订单" 只显示 **1** （不包含 pending 订单）

**如果仍显示 2：**
- 说明云函数未部署成功
- 重新部署并清除缓存

### 3. 清除缓存

如果部署后数据仍不正确：

1. 在微信开发者工具中：**"工具" → "清除缓存" → "清除全部缓存"**
2. 关闭并重新打开小程序
3. 重新打开管理端首页

## 注意事项

1. **每次修改云函数代码后都需要重新部署**
2. **部署后可能有 1-2 分钟的生效延迟**
3. **如果使用了多个云环境，确保部署到正确的环境**
4. **部署时选择"云端安装依赖"以确保依赖包正确**
5. **查看部署日志确认是否有错误**

## 常见问题

### Q1: 部署后仍然是旧代码？

**A:** 可能原因：
1. 部署到了错误的云环境
2. 小程序缓存了旧数据
3. 云函数版本未更新

**解决方法：**
1. 确认云环境 ID 是否正确
2. 清除小程序缓存
3. 在云开发控制台查看云函数文件更新时间

### Q2: 部署失败？

**A:** 可能原因：
1. 网络问题
2. 云函数代码有语法错误
3. 云开发权限不足

**解决方法：**
1. 检查网络连接
2. 查看错误日志
3. 确认开发者权限

### Q3: 如何回滚到上一个版本？

**A:** 
1. 在云开发控制台的云函数页面
2. 选择对应的云函数
3. 点击"版本管理"
4. 选择要回滚的版本

## 相关云函数

如果修改了以下云函数，也需要重新部署：

- ✅ `admin` - 管理员功能（含数据统计）
- ✅ `order` - 订单管理
- ✅ `paymentNotify` - 支付回调
- ✅ `user` - 用户管理
- ✅ `auth` - 权限验证

---

*更新时间：2025-10-19*

