# 订单状态统一规范文档

## 📋 文档概述

本文档规定了系统中订单状态的统一标准，包括状态定义、流转规则、前后端映射、UI展示等。确保所有开发人员遵循统一的状态管理规范。

---

## 1. 订单状态定义

### 1.1 核心状态枚举

| 状态码 | 英文名称 | 中文名称 | 说明 | 可逆性 |
|--------|---------|---------|------|-------|
| `pending` | Pending Payment | 待支付 | 订单已创建，等待用户支付 | ✅ 可取消 |
| `paid` | Paid | 待发货 | 订单已支付，等待商家发货 | ✅ 可取消 |
| `shipped` | Shipped | 待收货 | 商品已发货，等待用户确认收货 | ❌ 不可取消 |
| `completed` | Completed | 已完成 | 订单已完成（用户确认收货） | ❌ 不可取消 |
| `cancelled` | Cancelled | 已取消 | 订单已取消 | ❌ 终态 |

### 1.2 状态说明

#### `pending` - 待支付
- **触发时机：** 用户点击"确认下单"，创建订单时
- **初始状态：** ✅ 是
- **用户可见：** ✅ 是
- **管理员可见：** ✅ 是
- **支付状态：** `paymentStatus: 'pending'`
- **可执行操作：**
  - 用户：继续支付、取消订单
  - 管理员：修改订单状态、取消订单
- **自动流转：** 支付成功后 → `paid`
- **超时处理：** 建议24小时后自动取消

#### `paid` - 待发货
- **触发时机：** 用户完成支付，支付回调确认到账
- **用户可见：** ✅ 是（显示为"待发货"）
- **管理员可见：** ✅ 是（显示为"待发货"）
- **支付状态：** `paymentStatus: 'paid'`
- **可执行操作：**
  - 用户：取消订单（发货前）
  - 管理员：发货、修改订单状态、取消订单
- **自动流转：** 管理员发货后 → `shipped`

#### `shipped` - 待收货
- **触发时机：** 管理员点击"发货"，填写快递单号
- **用户可见：** ✅ 是（显示为"待收货"）
- **管理员可见：** ✅ 是（显示为"已发货"）
- **支付状态：** `paymentStatus: 'paid'`
- **可执行操作：**
  - 用户：确认收货、查看物流
  - 管理员：查看订单、修改物流信息
- **自动流转：** 用户确认收货 → `completed`（或7天后自动确认）

#### `completed` - 已完成
- **触发时机：** 用户点击"确认收货"或系统自动确认
- **用户可见：** ✅ 是
- **管理员可见：** ✅ 是
- **支付状态：** `paymentStatus: 'paid'`
- **可执行操作：**
  - 用户：查看订单、申请售后
  - 管理员：查看订单
- **终态：** ✅ 是

#### `cancelled` - 已取消
- **触发时机：** 用户/管理员主动取消，或系统超时自动取消
- **用户可见：** ✅ 是
- **管理员可见：** ✅ 是（可在筛选中查看）
- **支付状态：** 
  - 未支付订单：`paymentStatus: 'pending'`
  - 已支付订单：`paymentStatus: 'refunded'`（需退款）
- **可执行操作：**
  - 用户：查看订单、删除订单
  - 管理员：查看订单
- **终态：** ✅ 是

---

## 2. 状态流转规则

### 2.1 正常流程

```
pending (待支付)
   ↓ [支付成功]
paid (待发货)
   ↓ [商家发货]
shipped (待收货)
   ↓ [确认收货]
completed (已完成)
```

### 2.2 异常流程

```
pending (待支付)
   ↓ [用户取消 / 超时]
cancelled (已取消)

paid (待发货)
   ↓ [用户/商家取消]
cancelled (已取消，需退款)
```

### 2.3 状态流转矩阵

| 当前状态 | pending | paid | shipped | completed | cancelled |
|---------|---------|------|---------|-----------|-----------|
| **可流转到** |  |  |  |  |  |
| pending | - | ✅ 支付 | ❌ | ❌ | ✅ 取消 |
| paid | ❌ | - | ✅ 发货 | ❌ | ✅ 取消 |
| shipped | ❌ | ❌ | - | ✅ 收货 | ❌ |
| completed | ❌ | ❌ | ❌ | - | ❌ |
| cancelled | ❌ | ❌ | ❌ | ❌ | - |

### 2.4 流转规则说明

#### 允许的流转
1. `pending` → `paid`：支付成功
2. `pending` → `cancelled`：取消未支付订单
3. `paid` → `shipped`：商家发货
4. `paid` → `cancelled`：取消已支付订单（需退款）
5. `shipped` → `completed`：确认收货

#### 禁止的流转
1. ❌ `shipped` → `cancelled`：已发货订单不能取消
2. ❌ `completed` → 任何状态：已完成订单不可逆转
3. ❌ `cancelled` → 任何状态：已取消订单不可恢复
4. ❌ 跨状态跳跃：必须按顺序流转

---

## 3. 前后端状态映射

### 3.1 数据库字段

**orders 集合：**

```javascript
{
  _id: "order_xxxxx",
  orderNo: "MH1729...",
  status: "pending",        // 订单状态（核心字段）
  paymentStatus: "pending", // 支付状态
  // ... 其他字段
}
```

### 3.2 云函数状态处理

#### 创建订单 (cloud/functions/order/index.js)

```javascript
// ✅ 正确：初始状态为 pending
const orderResult = await db.collection('orders').add({
  data: {
    // ...
    status: 'pending',        // 订单初始状态为待支付
    paymentStatus: 'pending', // 待支付
    createTime: new Date(),
    updateTime: new Date()
  }
});
```

#### 订单筛选 (cloud/functions/order/index.js)

```javascript
// ✅ 正确：使用精确匹配
if (status) {
  whereCondition.status = status;  // 精确匹配
} else {
  // "全部"订单：排除已取消
  whereCondition.status = _.neq('cancelled');
}
```

#### 订单统计 (cloud/functions/order/index.js)

```javascript
// ✅ 正确：分别统计
const pendingCount = await db.collection('orders')
  .where({ openid, status: 'pending' })  // 待支付
  .count();

const paidCount = await db.collection('orders')
  .where({ openid, status: 'paid' })     // 待发货
  .count();
```

#### 管理端统计 (cloud/functions/admin/index.js)

```javascript
// ✅ 正确：待发货只统计 paid 状态
const pendingShipmentCount = await db.collection('orders').where({
  status: 'paid'  // 只包括 paid 状态
}).count();
```

### 3.3 前端状态映射

#### 用户端订单列表 (pages/orders/orders.js)

```javascript
// ✅ 状态映射
const statusMap = {
  'pending': { text: '待支付', color: 'unpaid' },
  'paid': { text: '待发货', color: 'pending' },
  'shipped': { text: '待收货', color: 'shipping' },
  'completed': { text: '已完成', color: 'completed' },
  'cancelled': { text: '已取消', color: 'cancelled' }
};

// ✅ 订单统计
orderCounts: {
  all: 0,
  pending: 0,   // 待支付
  paid: 0,      // 待发货
  shipped: 0,   // 待收货
  completed: 0  // 已完成
}
```

#### 订单详情页 (pages/order-detail/order-detail.js)

```javascript
// ✅ 状态映射
const statusMap = {
  'pending': { text: '待支付', desc: '请尽快完成支付，超时订单将自动取消' },
  'paid': { text: '待发货', desc: '您的订单已付款，正在准备发货' },
  'shipped': { text: '待收货', desc: '您的包裹正在路上，请耐心等待' },
  'completed': { text: '已完成', desc: '订单已完成，感谢您的购买' },
  'cancelled': { text: '已取消', desc: '订单已取消' }
};
```

#### 管理端订单列表 (pages/admin-orders/admin-orders.js)

```javascript
// ✅ 状态映射
const statusMap = {
  'pending': '待支付',
  'paid': '待发货',
  'shipped': '已发货',
  'completed': '已完成',
  'cancelled': '已取消'
};

// ✅ 订单统计
statistics: {
  total: 0,
  unpaid: 0,    // 待支付（pending 状态）
  pending: 0,   // 待发货（paid 状态）
  shipped: 0,   // 已发货
  completed: 0, // 已完成
  cancelled: 0  // 已取消
}

// ✅ 筛选逻辑
if (currentFilter === 'pending') {
  // 待支付：只包括 pending 状态
  filteredOrders = orders.filter(order => order.status === 'pending');
} else if (currentFilter === 'paid') {
  // 待发货：只包括 paid 状态
  filteredOrders = orders.filter(order => order.status === 'paid');
}
```

---

## 4. UI 展示规范

### 4.1 状态图标

| 状态 | 图标 | 颜色 | 背景色 |
|------|------|------|--------|
| pending | 💳 | #FF6B6B | rgba(255, 107, 107, 0.1) |
| paid | 📦 | #FF9800 | rgba(255, 152, 0, 0.1) |
| shipped | 🚚 | #2196F3 | rgba(33, 150, 243, 0.1) |
| completed | ✅ | #4CAF50 | rgba(76, 175, 80, 0.1) |
| cancelled | ❌ | #9E9E9E | rgba(158, 158, 158, 0.1) |

### 4.2 订单列表展示

#### 用户端

```xml
<!-- 待支付订单 -->
<view class="order-status unpaid">待支付</view>
<view class="action-btn primary" bindtap="onContinuePay">继续支付</view>
<view class="action-btn secondary" bindtap="onCancelOrder">取消订单</view>

<!-- 待发货订单 -->
<view class="order-status pending">待发货</view>
<view class="action-btn secondary" bindtap="onCancelOrder">取消订单</view>

<!-- 待收货订单 -->
<view class="order-status shipping">待收货</view>
<view class="action-btn primary" bindtap="onConfirmReceive">确认收货</view>

<!-- 已完成订单 -->
<view class="order-status completed">已完成</view>

<!-- 已取消订单 -->
<view class="order-status cancelled">已取消</view>
```

#### 管理端

```xml
<!-- 待支付订单 -->
<view class="order-status unpaid">待支付</view>
<view class="action-btn" bindtap="onChangeStatus">修改状态</view>

<!-- 待发货订单 -->
<view class="order-status pending">待发货</view>
<view class="action-btn primary" bindtap="onShipOrder">发货</view>
<view class="action-btn" bindtap="onChangeStatus">修改</view>

<!-- 已发货订单 -->
<view class="order-status shipping">已发货</view>
<view class="action-btn" bindtap="onChangeStatus">修改</view>

<!-- 已完成订单 -->
<view class="order-status completed">已完成</view>

<!-- 已取消订单 -->
<view class="order-status cancelled">已取消</view>
```

### 4.3 状态标签页

#### 用户端（pages/orders/orders.wxml）

```
[全部] [待支付] [待发货] [待收货] [已完成]
```

#### 管理端（pages/admin-orders/admin-orders.wxml）

```
[全部] [待支付] [待发货] [已发货] [已完成] [已取消]
```

---

## 5. 操作权限规范

### 5.1 用户端权限

| 操作 | pending | paid | shipped | completed | cancelled |
|------|---------|------|---------|-----------|-----------|
| 继续支付 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 取消订单 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 确认收货 | ❌ | ❌ | ✅ | ❌ | ❌ |
| 查看物流 | ❌ | ❌ | ✅ | ✅ | ❌ |
| 申请售后 | ❌ | ❌ | ✅ | ✅ | ❌ |
| 查看订单 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 删除订单 | ❌ | ❌ | ❌ | ❌ | ✅ |

### 5.2 管理端权限

| 操作 | pending | paid | shipped | completed | cancelled |
|------|---------|------|---------|-----------|-----------|
| 发货 | ❌ | ✅ | ❌ | ❌ | ❌ |
| 修改状态 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 取消订单 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 查看订单 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 导出订单 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 批量发货 | ❌ | ✅ | ❌ | ❌ | ❌ |

### 5.3 权限验证

#### 发货权限验证

```javascript
// ✅ 正确：只有 paid 状态可以发货
if (order.status !== 'paid') {
  wx.showToast({
    title: order.status === 'pending' ? '订单未支付，无法发货' : '订单状态异常',
    icon: 'none'
  });
  return;
}
```

#### 取消权限验证

```javascript
// ✅ 正确：只有 pending 和 paid 可以取消
if (order.status !== 'pending' && order.status !== 'paid') {
  wx.showToast({
    title: '该订单无法取消',
    icon: 'none'
  });
  return;
}
```

---

## 6. 测试规范

### 6.1 功能测试用例

#### 测试用例1：订单创建

| 步骤 | 操作 | 预期结果 |
|------|------|---------|
| 1 | 用户加购商品 | 购物车显示商品 |
| 2 | 点击"结算" | 跳转到订单确认页 |
| 3 | 点击"确认下单" | 创建订单，`status: 'pending'` |
| 4 | 用户端查看订单 | "待支付"列表中显示订单 |
| 5 | 管理端查看订单 | "待支付"列表中显示订单 |

#### 测试用例2：支付流程

| 步骤 | 操作 | 预期结果 |
|------|------|---------|
| 1 | 点击"去支付" | 调用支付接口 |
| 2 | 完成支付 | 前端更新 `status: 'paid'` |
| 3 | 支付回调 | 后端确认 `status: 'paid'` |
| 4 | 用户端查看订单 | "待发货"列表中显示订单 |
| 5 | 管理端查看订单 | "待发货"列表中显示订单 |

#### 测试用例3：发货流程

| 步骤 | 操作 | 预期结果 |
|------|------|---------|
| 1 | 管理员点击"发货" | 弹出发货窗口 |
| 2 | 填写快递单号 | 输入快递信息 |
| 3 | 确认发货 | `status: 'shipped'` |
| 4 | 用户端查看订单 | "待收货"列表中显示订单 |
| 5 | 管理端查看订单 | "已发货"列表中显示订单 |

#### 测试用例4：取消订单

| 步骤 | 操作 | 预期结果 |
|------|------|---------|
| 1 | 用户创建订单（未支付） | `status: 'pending'` |
| 2 | 点击"取消订单" | 弹出确认窗口 |
| 3 | 确认取消 | `status: 'cancelled'` |
| 4 | 用户端查看 | "待支付"列表中移除 |
| 5 | 管理端查看 | "已取消"列表中显示 |

#### 测试用例5：状态筛选

| 筛选条件 | 应显示的订单 | 不应显示的订单 |
|---------|-------------|---------------|
| 全部 | pending, paid, shipped, completed | cancelled |
| 待支付 | pending | paid, shipped, completed, cancelled |
| 待发货 | paid | pending, shipped, completed, cancelled |
| 待收货 | shipped | pending, paid, completed, cancelled |
| 已完成 | completed | pending, paid, shipped, cancelled |
| 已取消 | cancelled | pending, paid, shipped, completed |

### 6.2 边界测试

#### 边界测试1：状态流转限制

| 操作 | 预期结果 |
|------|---------|
| 尝试对 pending 订单发货 | ❌ 提示"订单未支付，无法发货" |
| 尝试对 shipped 订单取消 | ❌ 提示"该订单无法取消" |
| 尝试对 completed 订单修改状态 | ❌ 提示"已完成订单不可修改" |
| 尝试对 cancelled 订单恢复 | ❌ 不显示任何操作按钮 |

#### 边界测试2：并发支付

| 场景 | 处理方式 |
|------|---------|
| 支付回调重复通知 | 幂等性检查，已 paid 则跳过 |
| 前端先更新，回调后到 | 保持 paid 状态不变 |
| 回调先到，前端后更新 | 保持 paid 状态不变 |

### 6.3 性能测试

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| 订单列表加载 | < 1s | 查询100条订单 |
| 订单状态更新 | < 500ms | 更新单个订单状态 |
| 订单统计 | < 2s | 统计全部订单 |
| 批量发货 | < 5s | 批量发货10个订单 |

---

## 7. 异常处理规范

### 7.1 支付异常

#### 支付超时

```javascript
// 用户支付超时（建议24小时）
if (order.status === 'pending' && isPastDeadline(order.createTime, 24)) {
  await updateOrderStatus(orderId, 'cancelled');
  await releaseInventory(order.products);
}
```

#### 支付失败

```javascript
// 支付失败后允许重新支付
if (order.status === 'pending') {
  // 允许用户点击"继续支付"
  wx.showModal({
    title: '继续支付',
    content: `订单金额：¥${order.totalAmount}\n是否继续完成支付？`
  });
}
```

### 7.2 库存异常

#### 创建订单时库存不足

```javascript
// 创建订单前检查库存
const product = await db.collection('products').doc(productId).get();
if (product.stock < quantity) {
  return { success: false, message: '库存不足' };
}
```

#### 支付后库存不足

```javascript
// 支付回调时再次检查库存
if (product.stock < order.quantity) {
  // 自动取消订单并退款
  await updateOrderStatus(orderId, 'cancelled');
  await refund(order.transactionId);
  await notifyUser('订单已取消并退款：库存不足');
}
```

### 7.3 系统异常

#### 云函数调用失败

```javascript
try {
  const res = await wx.cloud.callFunction({
    name: 'order',
    data: { action: 'getOrders', status: 'pending' }
  });
} catch (error) {
  console.error('获取订单失败:', error);
  wx.showToast({
    title: '加载失败，请重试',
    icon: 'none'
  });
  // 显示默认数据或重试提示
}
```

#### 数据库操作失败

```javascript
try {
  await db.collection('orders').doc(orderId).update({
    data: { status: 'shipped' }
  });
} catch (error) {
  console.error('更新订单失败:', error);
  // 记录日志，稍后重试或人工处理
}
```

---

## 8. 数据统计规范

### 8.1 订单数量统计

```javascript
// ✅ 正确的统计方式
const statistics = {
  // 全部订单（排除已取消）
  all: await db.collection('orders')
    .where({ status: _.neq('cancelled') })
    .count(),
  
  // 待支付订单
  pending: await db.collection('orders')
    .where({ status: 'pending' })
    .count(),
  
  // 待发货订单
  paid: await db.collection('orders')
    .where({ status: 'paid' })
    .count(),
  
  // 待收货订单
  shipped: await db.collection('orders')
    .where({ status: 'shipped' })
    .count(),
  
  // 已完成订单
  completed: await db.collection('orders')
    .where({ status: 'completed' })
    .count(),
  
  // 已取消订单
  cancelled: await db.collection('orders')
    .where({ status: 'cancelled' })
    .count()
};
```

### 8.2 金额统计

```javascript
// 按状态统计金额
const salesStats = {
  // 待支付金额（未收款）
  pendingAmount: await sumOrderAmount({ status: 'pending' }),
  
  // 已支付金额（已收款，包含 paid, shipped, completed）
  paidAmount: await sumOrderAmount({ 
    status: _.in(['paid', 'shipped', 'completed']) 
  }),
  
  // 已完成金额（已结算）
  completedAmount: await sumOrderAmount({ status: 'completed' }),
  
  // 已取消金额（需退款）
  cancelledAmount: await sumOrderAmount({ 
    status: 'cancelled',
    paymentStatus: 'paid'  // 已支付但被取消的订单
  })
};
```

### 8.3 转化率统计

```javascript
// 订单转化漏斗
const conversionFunnel = {
  created: pendingCount + paidCount + shippedCount + completedCount,  // 创建订单数
  paid: paidCount + shippedCount + completedCount,                    // 支付订单数
  shipped: shippedCount + completedCount,                             // 发货订单数
  completed: completedCount,                                          // 完成订单数
  
  // 转化率
  paymentRate: (paid / created * 100).toFixed(2) + '%',       // 支付率
  shipmentRate: (shipped / paid * 100).toFixed(2) + '%',      // 发货率
  completionRate: (completed / shipped * 100).toFixed(2) + '%' // 完成率
};
```

---

## 9. 文档变更记录

| 日期 | 版本 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 2025-10-19 | v1.0 | 创建文档，规范订单状态定义和流转 | AI Assistant |
| 2025-10-19 | v1.1 | 增加管理端待支付状态 | AI Assistant |
| 2025-10-19 | v1.2 | 修复订单详情页状态映射 | AI Assistant |
| 2025-10-19 | v1.3 | 修复数据看板统计逻辑 | AI Assistant |

---

## 10. 附录

### 10.1 相关文档

- [订单状态管理修复说明.md](./订单状态管理修复说明.md)
- [待支付状态功能说明.md](./待支付状态功能说明.md)
- [订单列表筛选逻辑修复说明.md](./订单列表筛选逻辑修复说明.md)
- [管理端待支付状态功能说明.md](./管理端待支付状态功能说明.md)

### 10.2 常见问题

#### Q1: 为什么 pending 和 paid 要分开？

**A:** 这是基于业务流程的合理设计：
- `pending` = 订单已创建但未支付，用户需要完成支付
- `paid` = 订单已支付，商家需要准备发货

分开后的好处：
1. **用户端**：清楚知道哪些订单需要支付，哪些订单在等待发货
2. **管理端**：清楚知道哪些订单需要催付，哪些订单需要配货发货
3. **数据分析**：准确统计支付转化率和订单处理效率

#### Q2: 为什么已发货订单不能取消？

**A:** 这是常见的电商规则：
1. **成本问题**：商品已发出，取消需要召回，成本高
2. **体验问题**：用户可以拒收，商家承担来回运费
3. **流程问题**：已发货说明商品已离库，库存已扣除

解决方案：用户可以在收货后申请售后退货。

#### Q3: 订单状态可以手动修改吗？

**A:** 管理员可以修改，但有限制：
- ✅ 可以修改：`pending → paid` （手动标记已支付）
- ✅ 可以修改：`paid → shipped` （正常发货流程）
- ✅ 可以修改：`shipped → completed` （手动完成订单）
- ❌ 不建议：跨状态跳跃修改
- ❌ 禁止：修改已取消订单

#### Q4: 如何处理支付回调延迟？

**A:** 采用多重保障机制：
1. **前端立即更新**：支付成功后前端直接调用云函数更新状态
2. **幂等性检查**：支付回调时检查订单是否已是 `paid` 状态
3. **超时重试**：微信支付回调支持重试机制
4. **人工核实**：长时间未收到回调可人工查询支付状态

### 10.3 技术栈说明

- **前端框架**：微信小程序原生框架
- **后端服务**：微信云开发（Node.js 16）
- **数据库**：微信云数据库（MongoDB）
- **支付服务**：微信支付 API v3

### 10.4 联系方式

如有疑问或建议，请联系开发团队。

---

## 总结

本规范文档定义了系统中订单状态的统一标准，确保：

✅ **状态定义清晰** - 每个状态有明确的含义和触发条件  
✅ **流转规则明确** - 规定了允许和禁止的状态流转  
✅ **前后端一致** - 统一的状态映射和命名规范  
✅ **UI展示统一** - 规范的图标、颜色和文案  
✅ **权限控制严格** - 明确的操作权限和验证规则  
✅ **异常处理完善** - 覆盖常见异常场景  
✅ **测试用例完整** - 提供详细的测试规范  

**请所有开发人员严格遵守本规范！**

---

*最后更新时间：2025-10-19*  
*文档版本：v1.3*

