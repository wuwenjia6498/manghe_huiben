# 🔧 微信支付常见问题解决方案

*最后更新：2024年*

---

## ❌ 问题1：attach字段长度超限

### 错误信息
```
"输入源"/body/attach"映射到值字段"附加数据"字符串规则校验失败，
字节数 150，大于最大值 128"
```

### 原因分析
微信支付API对 `attach` 字段有严格的长度限制：
- **最大字节数**：128字节
- **注意**：中文字符占3个字节，英文字符占1个字节

### 错误示例 ❌
```javascript
const paymentOptions = {
  attach: JSON.stringify({
    orderId: '123456',
    orderNo: 'MH1760064345961282',
    productType: 'blindbox',
    productName: '0-3岁九成新10本装绘本盲盒、3-6岁全新20本装绘本盲盒'
  })
};
// 这个JSON字符串超过了128字节！
```

### 正确做法 ✅
```javascript
const paymentOptions = {
  // 只传订单号，简短且足够
  attach: orderNo  // 如：'MH1760064345961282'
};

// 或者传简短的标识
attach: 'order_' + orderId
```

### 已修复的文件
1. ✅ `pages/order/order.js` - 订单支付
2. ✅ `pages/profile/profile.js` - 支付测试

---

## 📋 微信支付字段限制参考

### 常用字段的限制

| 字段名 | 类型 | 最大长度 | 说明 |
|--------|------|----------|------|
| `attach` | string | 128字节 | 附加数据，回调时原样返回 |
| `description` | string | 127字节 | 商品描述 |
| `out_trade_no` | string | 32字符 | 商户订单号 |
| `body` | string | 128字节 | 商品简单描述（旧版API） |

### 字节数计算
```javascript
// 中文：3字节/字符
'绘本' → 6字节

// 英文：1字节/字符  
'order' → 5字节

// 数字：1字节/字符
'123456' → 6字节
```

---

## ✅ 最佳实践

### 1. attach字段使用建议

**推荐方案**（按优先级）：

#### 方案A：只传订单号 ⭐⭐⭐（推荐）
```javascript
attach: orderNo  // 'MH1760064345961282'
```
**优点**：
- 简短可靠
- 唯一标识订单
- 可通过订单号查询完整信息

#### 方案B：传简短JSON
```javascript
attach: JSON.stringify({
  order: orderNo,
  type: 'box'  // 简短标识
})
```
**注意**：确保总字节数 < 128

#### 方案C：不使用attach
```javascript
attach: ''  // 空字符串也可以
```
**说明**：attach是可选字段

### 2. 商品信息存储

**不要**把商品详情放在 attach 中 ❌
```javascript
// 错误示例
attach: JSON.stringify({
  products: [
    {name: '商品1', price: 100},
    {name: '商品2', price: 200}
  ]
})
```

**应该**在创建订单时保存到数据库 ✅
```javascript
// 创建订单时保存完整信息
wx.cloud.callFunction({
  name: 'order',
  data: {
    action: 'createOrder',
    products: orderItems,  // 完整的商品信息
    // ... 其他详细信息
  }
});

// 支付时只传订单号
attach: orderNo
```

### 3. description字段使用

```javascript
// 简洁明了，突出重点
description: `绘本盲盒订单-${orderNo}`

// 或者
description: `绘本盲盒×${itemCount}件`

// 不要太长
description: `绘本盲盒订单-包含0-3岁九成新10本装、3-6岁...` // ❌ 太长
```

---

## 🧪 验证方法

### 检查字节数
```javascript
// 方法1：使用Buffer（Node.js）
Buffer.from(attachString).length

// 方法2：简单估算
// 中文字符数 × 3 + 英文字符数 × 1

// 示例
const attach = 'MH1760064345961282';
console.log('字节数:', attach.length);  // 18字节 ✅

const attach2 = '绘本盲盒订单';
// 6个中文 = 6 × 3 = 18字节 ✅
```

---

## 🔄 其他常见问题

### 问题2：订单号格式错误

**错误**：
```
商户订单号格式不正确
```

**解决**：
```javascript
// 确保订单号符合规范
// - 长度：6-32字符
// - 字符：只能是字母、数字、下划线、横杠
const orderNo = 'MH' + Date.now();  // ✅
```

### 问题3：金额格式错误

**错误**：
```
订单金额必须为整数
```

**解决**：
```javascript
// 必须转换为分（整数）
const amount = Math.round(finalAmount * 100);  // ✅

// 错误示例
const amount = 69.50;  // ❌ 不能是小数
```

### 问题4：签名错误

**错误**：
```
签名验证失败
```

**解决**：
1. 检查商户API密钥是否正确
2. 检查证书是否有效
3. 确保时间戳格式正确
4. 验证签名算法是否为RSA

---

## 📝 调试建议

### 1. 查看完整错误信息
```javascript
console.log('支付错误详情:', error);
console.log('错误码:', error.code);
console.log('错误消息:', error.message);
```

### 2. 验证支付参数
```javascript
console.log('=== 支付参数验证 ===');
console.log('金额（分）:', paymentAmount);
console.log('描述长度:', description.length);
console.log('attach长度:', attach.length);
console.log('attach字节数:', Buffer.from(attach).length);
```

### 3. 检查云函数日志
- 打开云开发控制台
- 进入云函数日志
- 查看 `createPayment` 云函数的详细日志

---

## ✅ 修复后的支付流程

### 完整示例

```javascript
// 1. 创建订单（保存完整信息到数据库）
const orderResult = await wx.cloud.callFunction({
  name: 'order',
  data: {
    action: 'createOrder',
    products: [
      {
        name: '0-3岁九成新10本装绘本盲盒',
        price: 67.15,
        quantity: 1
      }
    ],
    address: addressInfo,
    totalAmount: 69,
    // ... 其他详细信息都在这里
  }
});

// 2. 准备支付参数（简洁）
const paymentOptions = {
  amount: 6900,  // 69元 = 6900分
  description: `绘本盲盒订单-${orderNo}`,
  attach: orderNo  // ✅ 只传订单号，简短可靠
};

// 3. 调用支付
paymentSDK.processPayment(userInfo, paymentOptions);
```

---

## 🎯 总结

### 关键点
1. ✅ **attach字段**：不超过128字节，建议只传订单号
2. ✅ **商品信息**：保存在数据库，不通过attach传递
3. ✅ **金额单位**：必须是分（整数）
4. ✅ **description**：简洁明了，不超过127字节

### 修复清单
- [x] ✅ 修复 `pages/order/order.js` 的 attach 字段
- [x] ✅ 修复 `pages/profile/profile.js` 的 attach 字段
- [x] ✅ 添加详细注释说明
- [x] ✅ 创建问题解决文档

---

**现在可以正常支付了！** 🎉

重新测试支付流程即可。

