# 微信支付回调地址配置指南

## ⚠️ 当前问题
支付时报错：`notify_url 字符串规则校验失败`

这是因为 `WX_NOTIFY_URL` 环境变量未正确配置。

## 🔧 解决步骤

### 第1步：为 paymentNotify 云函数配置 HTTP 触发器

1. **打开微信开发者工具**

2. **进入云开发控制台**：
   - 点击工具栏的 "云开发" 按钮
   - 或者点击顶部菜单：工具 → 云开发控制台

3. **找到 paymentNotify 云函数**：
   - 点击左侧 "云函数" 菜单
   - 在云函数列表中找到 `paymentNotify`

4. **配置 HTTP 访问服务**：
   - 点击 `paymentNotify` 云函数名称进入详情页
   - 找到 "HTTP访问服务" 或 "触发器管理" 标签
   - 点击 "新建触发器" 或 "创建"
   - 选择 "HTTP触发"
   - 路径可以设置为：`/`（默认即可）
   - 点击 "确定"

5. **复制 HTTP 访问地址**：
   - 配置成功后会生成一个 URL，类似：
   ```
   https://service-xxx-xxx.ap-shanghai.apigw.tencentcs.com/release/paymentNotify
   ```
   - **复制这个完整的 URL**

### 第2步：配置 createPayment 云函数的环境变量

1. **找到 createPayment 云函数**：
   - 在云函数列表中点击 `createPayment`

2. **进入配置页面**：
   - 点击 "版本与配置" 标签
   - 点击 "配置" 子标签
   - 找到 "环境变量" 部分

3. **添加或更新 WX_NOTIFY_URL**：
   - 如果已存在 `WX_NOTIFY_URL`，点击 "编辑"
   - 如果不存在，点击 "新增环境变量"
   - 变量名：`WX_NOTIFY_URL`
   - 变量值：粘贴刚才复制的 HTTP 访问地址
   - 点击 "保存"

4. **重新部署 createPayment 云函数**：
   - 回到微信开发者工具
   - 右键点击 `cloud/functions/createPayment` 文件夹
   - 选择 "上传并部署：云端安装依赖"
   - 等待部署完成

### 第3步：验证配置

1. **重新测试支付**：
   - 在小程序中点击 "支付测试"
   - 应该能成功创建订单并调起支付界面

2. **检查日志**（可选）：
   - 云开发控制台 → 云函数 → createPayment → 调用日志
   - 查看是否有报错信息

## ✅ 配置完成标志

配置正确后，测试支付时应该：
1. 显示 "正在创建订单..."
2. 弹出微信支付界面
3. 显示支付金额：0.05元
4. 商品描述：绘本盲盒测试购买

## 📝 环境变量清单

确保 createPayment 云函数有以下 6 个环境变量：

| 环境变量名 | 说明 | 示例 |
|-----------|------|------|
| `WX_APP_ID` | 小程序AppID | wx1234567890abcdef |
| `WX_MCH_ID` | 商户号 | 1234567890 |
| `WX_API_KEY` | APIv3密钥 | 32位随机字符串 |
| `WX_SERIAL_NO` | 证书序列号 | 1234567890ABCDEF |
| `WX_PRIVATE_KEY` | 商户私钥 | -----BEGIN PRIVATE KEY-----... |
| `WX_NOTIFY_URL` | ⚠️ **就是现在要配置的** | https://service-xxx.com/release/paymentNotify |

## 🆘 常见问题

### Q1: 找不到 "HTTP访问服务" 选项？
A: 可能叫 "触发器管理" 或 "HTTP触发器"，不同版本的云开发控制台界面可能略有不同。

### Q2: HTTP访问地址格式不对？
A: 确保地址是完整的，包含：
- https:// 开头
- 包含域名
- 以 /paymentNotify 结尾

### Q3: 配置后还是报错？
A: 
1. 确认环境变量已保存
2. 确认已重新部署 createPayment 云函数
3. 清除小程序缓存后重试

---

**配置完成后，请回来测试支付功能！**

